class AuthManager {
    constructor() {
        this.currentUser = null;
        this.isAuthenticated = false;
        this.init();
    }

    init() {
        this.checkExistingSession();
        this.setupEventListeners();
        this.setupUserTypeToggle();
    }

    setupEventListeners() {
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => this.handleLogin(e));
        }

        const signupLink = document.getElementById('signupLink');
        if (signupLink) {
            signupLink.addEventListener('click', (e) => {
                e.preventDefault();
                this.showSignupModal();
            });
        }
    }

    setupUserTypeToggle() {
        const touristRadio = document.getElementById('touristType');
        const authorityRadio = document.getElementById('authorityType');
        const touristIdGroup = document.getElementById('touristIdGroup');
        const authorityIdGroup = document.getElementById('authorityIdGroup');

        if (touristRadio && authorityRadio) {
            touristRadio.addEventListener('change', () => {
                touristIdGroup.classList.remove('hidden');
                authorityIdGroup.classList.add('hidden');
            });

            authorityRadio.addEventListener('change', () => {
                authorityIdGroup.classList.remove('hidden');
                touristIdGroup.classList.add('hidden');
            });
        }
    }

    async handleLogin(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const userType = formData.get('userType');
        const userId = userType === 'tourist' ? formData.get('touristId') : formData.get('authorityId');
        const password = formData.get('password');
        const securityCode = formData.get('securityCode');
        const rememberDevice = formData.get('rememberDevice') === 'on';
        const emergencyDashboard = formData.get('emergencyDashboard') === 'on';

        // Validate security code
        if (!this.validateSecurityCode(securityCode)) {
            this.showError('Invalid security code. Please use demo code: 1234');
            return;
        }

        // Authenticate user
        if (this.authenticateUser(userType, userId, password, securityCode)) {
            this.currentUser = {
                type: userType,
                id: userId,
                name: this.getUserName(userType, userId),
                timestamp: new Date().toISOString(),
                rememberDevice: rememberDevice,
                emergencyDashboard: emergencyDashboard
            };
            
            this.isAuthenticated = true;
            this.saveSession();
            this.redirectToDashboard();
        } else {
            this.showError('Invalid credentials. Please check your ID, password, and security code.');
        }
    }

    authenticateUser(userType, userId, password, securityCode) {
        // Demo authentication logic - In real app, this would call your backend
        const demoCredentials = {
            authority: [
                { id: 'AUTH-001', password: 'demo123', securityCode: '1234', name: 'Central Command' },
                { id: 'AUTH-002', password: 'demo123', securityCode: '1234', name: 'Rapid Response Unit' }
            ],
            tourist: [
                { id: 'TOUR-001', password: 'demo123', securityCode: '1234', name: 'John Traveler' },
                { id: 'TOUR-002', password: 'demo123', securityCode: '1234', name: 'Sarah Explorer' }
            ]
        };

        const credentials = demoCredentials[userType];
        const user = credentials.find(u => 
            u.id === userId && 
            u.password === password && 
            u.securityCode === securityCode
        );

        return !!user;
    }

    validateSecurityCode(code) {
        // Demo validation - accept 1234 or any 4-digit code for demo
        return code === '1234' || (/^\d{4}$/.test(code));
    }

    getUserName(userType, userId) {
        const names = {
            authority: {
                'AUTH-001': 'Central Command Unit',
                'AUTH-002': 'Rapid Response Team'
            },
            tourist: {
                'TOUR-001': 'John Traveler',
                'TOUR-002': 'Sarah Explorer'
            }
        };
        return names[userType]?.[userId] || userId;
    }

    saveSession() {
        if (this.currentUser.rememberDevice) {
            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
            localStorage.setItem('isAuthenticated', 'true');
        } else {
            sessionStorage.setItem('currentUser', JSON.stringify(this.currentUser));
            sessionStorage.setItem('isAuthenticated', 'true');
        }
    }

    checkExistingSession() {
        // Check both localStorage and sessionStorage
        let savedUser = localStorage.getItem('currentUser');
        let isAuthenticated = localStorage.getItem('isAuthenticated');
        
        if (!savedUser) {
            savedUser = sessionStorage.getItem('currentUser');
            isAuthenticated = sessionStorage.getItem('isAuthenticated');
        }
        
        if (savedUser && isAuthenticated === 'true') {
            this.currentUser = JSON.parse(savedUser);
            this.isAuthenticated = true;
            this.redirectToDashboard();
        }
    }

    redirectToDashboard() {
        const dashboardMap = {
            tourist: 'tourist-dashboard.html',
            authority: 'authority-dashboard.html'
        };
        
        // Add a small delay to show successful login
        setTimeout(() => {
            window.location.href = dashboardMap[this.currentUser.type];
        }, 500);
    }

    showError(message) {
        // Remove any existing error messages
        const existingError = document.querySelector('.error-message');
        if (existingError) {
            existingError.remove();
        }

        // Create error message element
        const errorElement = document.createElement('div');
        errorElement.className = 'error-message';
        errorElement.innerHTML = `
            <span class="error-icon">⚠️</span>
            <span class="error-text">${message}</span>
        `;

        // Insert before the login button
        const loginForm = document.getElementById('loginForm');
        const loginBtn = loginForm.querySelector('.login-btn');
        loginForm.insertBefore(errorElement, loginBtn);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorElement.parentElement) {
                errorElement.remove();
            }
        }, 5000);
    }

    showSignupModal() {
        alert('Sign up feature coming soon! For now, please use the demo credentials provided.');
    }

    logout() {
        this.currentUser = null;
        this.isAuthenticated = false;
        
        // Clear both storage types
        localStorage.removeItem('currentUser');
        localStorage.removeItem('isAuthenticated');
        sessionStorage.removeItem('currentUser');
        sessionStorage.removeItem('isAuthenticated');
        
        window.location.href = 'index.html';
    }

    getCurrentUser() {
        return this.currentUser;
    }

    isUserAuthenticated() {
        return this.isAuthenticated;
    }
}

// Initialize Auth Manager
const authManager = new AuthManager();

// Make it globally available for logout functionality
window.authManager = authManager; 
